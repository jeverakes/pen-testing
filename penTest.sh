#! /bin/bash

source config.sh

date=$(date +%b%y%H%M)
# task name
tName="$(curl -s http://45.55.121.100:8080/get/next | jq '.[].LastName' | tr -d '"')"
# host name
hName="$(curl -s http://45.55.121.100:8080/get/next | jq '.[].Server' | tr -d '"')"
# this is for the name of the saved report
sName=$tName$date
format="c402cc3e-b531-11e1-9163-406186ea4fc5" #pdf format
ext="pdf" #saving in pdf

# get the ID of the current job
cID="$(curl -s http://45.55.121.100:8080/get/next | jq '.[].id' | tr -d '"')"

# set the current job to processing
curl -s http://45.55.121.100:8080/set/status/processing/$cID

# full and fast scan ID
type="daba56c8-73ec-11df-a475-002264764cea"

# create target
omp -u $USER -w $PASS -iX '
<create_target>
<name>'$tName'</name>
<hosts>'$hName'</hosts>
</create_target>'

# grep target id
omp -u $USER -w $PASS -T | grep $tName > target
targetid=$(head -c 36 target)

# create task...or scan
omp -u $USER -w $PASS -iX '
<create_task>
<name>'$sName'</name>
<config id='\"$type\"'/>
<target id='\"$targetid\"'/>
</create_task>'

# grep scan id
omp -u $USER -w $PASS -G | grep $tName > scan
scanid=$(head -c 36 scan)

# start scan
#omp -u $USER -w $PASS -S $scanid
omp -u $USER -w $PASS -X '<start_task task_id='\"$scanid\"'/>'

# check status of scan
omp -u $USER -w $PASS -G | tee inProg
cat inProg | grep Done > isdone

while ! [ -s isdone ];
do
	rm inProg
	sleep 120
	omp -u $USER -w $PASS -G | tee inProg
	cat inProg | grep Done > isdone
done

# get the details of the scan (required by process)
omp -u $USER -w $PASS -iX '<get_tasks task_id='\"$scanid\"' details="1"/>' | tee report

# get the report id and save it to name the file
cat report | grep 'report id' > reportfile
reportid=$(awk '{print substr($0,23,36); exit}' reportfile)

# save the pdf report
omp -u $USER -w $PASS -R $reportid -f $format > Documents/$sName.$ext

# delete the scan id (clean up)
omp -u $USER -w $PASS -D $scanid

# delete the target id (clean up)
omp -u $USER -w $PASS -X '<delete_target target_id="'$targetid'"/>'

# set the record to done
curl -s http://45.55.121.100:8080/set/status/done/$cID
